2C. Add Flow Variables
Click Flow Variables (⚙️ icon) and add these:
Variable NameTypeDefault Valuebusiness_line_approver_sys_idString(empty)auto_approve_business_lineBooleanfalsehas_errorBooleanfalseerror_messageString(empty)request_cancelledBooleanfalsebusiness_line_approval_resultString(empty)
2D. Build the Flow Actions
Here's the exact sequence of actions to add:
Action 1: Set Flow Variables - Find Business Line Approver

Add Action → Flow Logic → Set Flow Variables
Click Script toggle
Add this script:

javascript(function() {
    var helper = new x_banun_bunow_si_0.SignatureHelper();
    
    // Get the requested for user from the trigger record
    var requestedForSysId = fd_data.trigger.current.requested_for.sys_id;
    var openedBySysId = fd_data.trigger.current.opened_by.sys_id;
    
    // Find the business line approver
    var approverResult = helper.findBusinessLineApprover(requestedForSysId);
    
    // Set flow variables based on result
    if (approverResult.found) {
        fd_data.business_line_approver_sys_id = approverResult.approver_sys_id;
        
        // Check if should auto-approve
        var shouldAutoApprove = helper.shouldAutoApproveBusinessLine(
            openedBySysId,
            requestedForSysId
        );
        
        fd_data.auto_approve_business_line = shouldAutoApprove;
        
    } else {
        fd_data.has_error = true;
        fd_data.error_message = approverResult.error_message;
        fd_data.request_cancelled = approverResult.is_ceo;
    }
})();
Action 2: If - Check for Errors

Add Action → Flow Logic → If
Set Condition:

Condition 1: Flow Variable has_error is true



THEN Branch (Has Error):
Action 2.1: Update Record - Cancel Request

Action: ServiceNow Core → Update Record
Record: Trigger → Current Record
Fields to Update:

State: cancelled
Work Notes: Request cancelled: [Flow Variables → error_message]



Action 2.2: Send Notification - Cancellation

Action: ServiceNow Core → Send Email
To: Trigger → Current Record → Opened by → Email
Subject: Authority Limit Request Cancelled
Body:

Your authority limit request has been cancelled.
Reason: ${fd_data.error_message}
Request Number: ${fd_data.trigger.current.number}
Action 2.3: Exit Flow

Action: Flow Logic → Exit

Action 3: If - Check Auto Approval (Outside the Error IF)

Add Action → Flow Logic → If
Set Condition:

Condition 1: Flow Variable auto_approve_business_line is true



THEN Branch (Auto Approve):
Action 3.1: Update Record - Auto Approved

Action: ServiceNow Core → Update Record
Record: Trigger → Current Record
Fields to Update:

State: business_line_approved
Business Line Approver: [Flow Variables → business_line_approver_sys_id]
Work Notes: Business Line approval auto-approved - requester has authority



Action 3.2: Set Flow Variables

Set business_line_approval_result = approved

ELSE Branch (Need Approval):
Action 3.3: Ask For Approval

Action: ServiceNow Core → Ask for Approval
Approval Details:

Record: Trigger → Current Record
Table: Your parent table name
Anyone Approves: checked
Users: Look Up Record:

Table: sys_user
Sys ID: [Flow Variables → business_line_approver_sys_id]





Action 3.4: If - Check Approval Response

Condition: 3.3 - Ask for Approval → State is Approved

THEN (Approved):

Update Record → State = business_line_approved
Set Flow Variables → business_line_approval_result = approved

ELSE (Rejected):

Update Record → State = business_line_rejected
Send Email → Notify opened by of rejection
Exit Flow

2E. Test the Flow

Click Test button
Select a recent record or create a test record
Run Test and verify:

✅ Business line approver is found correctly
✅ Auto-approval works when conditions are met
✅ CEO detection cancels the request
✅ Approval creation works
✅ Email notifications are sent



2F. Next Steps
Once this is working, we'll add:

Child record processing (Credit/Non-Credit subflows)
Parallel processing logic
Final status updates

Should we continue with testing this first part, or would you like me to show you how to add the child record processing now?

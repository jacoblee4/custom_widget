checkDelegatedAuthority: function(approverSysId, amount, type) {
        var result = {
            has_authority: false,
            threshold: 0,
            message: ''
        };

        if (!approverSysId || !amount) {
            result.message = 'Missing approver or amount';
            return result;
        }

        var table = (type === 'credit') ?
            'x_banun_bunow_si_0_crmc_delegated_authority' :
            'x_banun_bunow_si_0_ormc_delegated_authority';

        var gr = new GlideRecord(table);
        gr.addQuery('delegate_name', approverSysId);
		gr.addEncodedQuery('active=true^delegate_name.active=true'); // Make sure the delegate record is active AND the user record for the delegate
        gr.query();

        if (gr.next()) {

            result.threshold = gr.getValue('authority_limit') || 0;
			
            if (result.threshold > 0 && amount <= result.threshold) {
                result.has_authority = true;
                result.message = 'Approver has delegated authority. Threshold: $' +
                    result.threshold.toLocaleString() + ' >= Request: $' + amount.toLocaleString();
            } else {
                result.message = 'Authority insufficient. Threshold: $' +
                    result.threshold.toLocaleString() + ' < Request: $' + amount.toLocaleString();
            }
        } else {
            result.message = 'No delegated authority found for approver';
        }

        return result;
    },

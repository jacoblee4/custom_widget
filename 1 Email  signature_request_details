(function runMailScript(current, template, email, email_action, event) {

    var parent, isChildApproval = false, childRecord = null;
    var currentTableName = current.getTableName();
    
    // Determine context: approval notification, child state change, or parent notification
    if (currentTableName == 'sysapproval_approver') {
        // This is an approval email - current is sysapproval_approver
        var documentRecord = current.document_id.getRefRecord();
        
        // Validation check for document record
        if (!documentRecord || !documentRecord.isValidRecord()) {
            gs.error('Email Script Error: Unable to retrieve document record from sysapproval_approver');
            return;
        }
        
        var documentTableName = documentRecord.getTableName();
        
        if (documentTableName == 'x_banun_bunow_si_0_credit_authority_limits' || 
            documentTableName == 'x_banun_bunow_si_0_non_credit_authority_limits') {
            // Document is a child record - get parent from the parent field
            isChildApproval = true;
            childRecord = documentRecord;
            parent = documentRecord.parent.getRefRecord();
        } else {
            // Document is the parent record itself
            parent = documentRecord;
        }
    } else if (currentTableName == 'x_banun_bunow_si_0_credit_authority_limits' || 
               currentTableName == 'x_banun_bunow_si_0_non_credit_authority_limits') {
        // This is a child state change notification - current is the child record
        childRecord = current;
        isChildApproval = true;
        parent = childRecord.parent.getRefRecord();
    } else if (currentTableName == 'x_banun_bunow_si_0_signature_request') {
        // This is a parent table notification - current is the parent record
        parent = current;
    } else {
        // Unknown table context
        gs.error('Email Script Error: Unexpected table context - ' + currentTableName);
        return;
    }
    
    // Validation check for parent
    if (!parent || !parent.isValidRecord()) {
        gs.error('Email Script Error: Unable to retrieve parent Signature Authority Request record');
        return;
    }
    
    var content = '<div style="font-family: Arial, sans-serif; color: #000000; max-width: 800px;">';
    var instanceURL = gs.getProperty('glide.servlet.uri');
    
    // Determine which record URL and number to display
    var recordURL, displayNumber;
    if (isChildApproval && childRecord) {
        // Show child record details
        recordURL = instanceURL + 'x/banun/signature-authority-workspace/record/' + childRecord.getTableName() + '/' + childRecord.sys_id;
        displayNumber = childRecord.getValue('number') || parent.number + ' (Child Record)';
    } else {
        // Show parent record details
        recordURL = instanceURL + 'x/banun/signature-authority-workspace/record/x_banun_bunow_si_0_signature_request/' + parent.sys_id;
        displayNumber = parent.number;
    }

    content += '<div style="background-color: #f5f5f5; padding: 15px; margin: 20px 0; border-left: 4px solid #00aae3;">';
    content += '<h3 style="color: #00aae3; margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #00aae3;">Request Details</h3>';
    content += '<table style="width: 100%; border-collapse: collapse;">';
    content += '<tr><td style="padding: 8px; font-weight: bold; width: 200px;">Request Number:</td><td style="padding: 8px;"><a href="' + recordURL + '" style="color: #00aae3; text-decoration: none; font-weight: 600;">' + displayNumber + '</a></td></tr>';
    
    // If this is a child approval/notification, show which type
    if (isChildApproval && childRecord) {
        var limitType = childRecord.getTableName() == 'x_banun_bunow_si_0_credit_authority_limits' ? 
                        'Credit Authority Limits' : 'Non-Credit Authority Limits';
        content += '<tr><td style="padding: 8px; font-weight: bold;">Limit Type:</td><td style="padding: 8px;">' + limitType + '</td></tr>';
    }
    
    content += '<tr><td style="padding: 8px; font-weight: bold;">Request Type:</td><td style="padding: 8px;">' + parent.request_type.getDisplayValue() + '</td></tr>';
    content += '<tr><td style="padding: 8px; font-weight: bold;">Job Code:</td><td style="padding: 8px;">' + parent.job_code.getDisplayValue() + '</td></tr>';
    
    // Only show Job Title if it has a value
    if (parent.job_code.job_description && parent.job_code.job_description.toString().trim() !== '') {
        content += '<tr><td style="padding: 8px; font-weight: bold;">Job Title:</td><td style="padding: 8px;">' + parent.job_code.job_description + '</td></tr>';
    }
    
    // Only show Job Function if it has a value
    if (parent.job_code.job_function_description && parent.job_code.job_function_description.toString().trim() !== '') {
        content += '<tr><td style="padding: 8px; font-weight: bold;">Job Function:</td><td style="padding: 8px;">' + parent.job_code.job_function_description + '</td></tr>';
    }
    
    content += '<tr><td style="padding: 8px; font-weight: bold;">Opened By:</td><td style="padding: 8px;">' + parent.opened_by.getDisplayValue() + '</td></tr>';
    content += '<tr><td style="padding: 8px; font-weight: bold;">Requested By:</td><td style="padding: 8px;">' + parent.requested_for.getDisplayValue() + '</td></tr>';
    content += '<tr><td style="padding: 8px; font-weight: bold; vertical-align: top;">Overall Business Need:</td><td style="padding: 8px;">' + parent.overall_business_need + '</td></tr>';
    content += '</table>';
    content += '</div>';

    template.print(content);

})(current, template, email, email_action, event);

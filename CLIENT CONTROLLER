<!-- CLIENT CONTROLLER -->
api.controller = function($scope, spUtil, $timeout) {
  var c = this;
  
  // Initialize variables
  c.jobCode = '';
  c.jobCodeDisplay = '';
  c.authorityLimits = [];
  c.loading = false;
  
  // Function to get job code value from the form
  c.getJobCodeValue = function() {
    // For record producers, try different methods to get the field value
    try {
      // Method 1: Direct g_form access
      if (typeof g_form !== 'undefined' && g_form.getValue) {
        return g_form.getValue('job_code');
      }
      
      // Method 2: Check if we're in a Service Portal form
      if (window.parent && window.parent.g_form) {
        return window.parent.g_form.getValue('job_code');
      }
      
      // Method 3: DOM query for record producer fields
      var jobCodeField = document.querySelector('select[name="job_code"], input[name="job_code"], [data-name="job_code"] select, [data-name="job_code"] input');
      if (jobCodeField) {
        return jobCodeField.value || jobCodeField.selectedOptions?.[0]?.value || '';
      }
      
      // Method 4: Angular form scope (for Service Portal)
      if ($scope.data && $scope.data.job_code) {
        return $scope.data.job_code;
      }
      
    } catch (e) {
      console.log('Error getting job code value:', e);
    }
    
    return '';
  };
  
  // Function to get job code display value
  c.getJobCodeDisplayValue = function() {
    try {
      // Method 1: g_form display value
      if (typeof g_form !== 'undefined' && g_form.getDisplayBox) {
        var displayBox = g_form.getDisplayBox('job_code');
        if (displayBox && displayBox.value) {
          return displayBox.value;
        }
      }
      
      // Method 2: Get text from selected option
      var jobCodeField = document.querySelector('select[name="job_code"], [data-name="job_code"] select');
      if (jobCodeField && jobCodeField.selectedOptions && jobCodeField.selectedOptions[0]) {
        return jobCodeField.selectedOptions[0].text;
      }
      
      // Method 3: For reference fields in Service Portal
      var displayField = document.querySelector('input[name="job_code_display"], [data-name="job_code"] input[type="text"]');
      if (displayField) {
        return displayField.value;
      }
      
    } catch (e) {
      console.log('Error getting job code display value:', e);
    }
    
    return '';
  };
  
  // Function to set up polling to monitor job code changes
  c.setupJobCodeMonitoring = function() {
    var lastJobCode = '';
    
    // Poll for changes every 500ms
    var checkInterval = setInterval(function() {
      var currentJobCode = c.getJobCodeValue();
      
      if (currentJobCode !== lastJobCode) {
        console.log('Job code changed from', lastJobCode, 'to', currentJobCode);
        lastJobCode = currentJobCode;
        c.jobCode = currentJobCode;
        c.jobCodeDisplay = c.getJobCodeDisplayValue();
        
        $timeout(function() {
          c.loadAuthorityLimits();
        });
      }
    }, 500);
    
    // Clean up interval when scope is destroyed
    $scope.$on('$destroy', function() {
      clearInterval(checkInterval);
    });
    
    // Also try to set up direct event listeners
    $timeout(function() {
      c.setupDirectListeners();
    }, 1000);
  };
  
  // Function to set up direct event listeners
  c.setupDirectListeners = function() {
    // Try to add change listeners to job code fields
    var selectors = [
      'select[name="job_code"]',
      'input[name="job_code"]', 
      '[data-name="job_code"] select',
      '[data-name="job_code"] input',
      '#job_code'
    ];
    
    selectors.forEach(function(selector) {
      var elements = document.querySelectorAll(selector);
      elements.forEach(function(element) {
        element.addEventListener('change', function() {
          console.log('Direct change event detected');
          $timeout(function() {
            c.jobCode = c.getJobCodeValue();
            c.jobCodeDisplay = c.getJobCodeDisplayValue();
            c.loadAuthorityLimits();
          });
        });
      });
    });
    
    // Try g_form callback if available
    try {
      if (typeof g_form !== 'undefined' && g_form.addOnChangeCallback) {
        g_form.addOnChangeCallback('job_code', function() {
          console.log('g_form change callback triggered');
          $timeout(function() {
            c.jobCode = c.getJobCodeValue();
            c.jobCodeDisplay = c.getJobCodeDisplayValue();
            c.loadAuthorityLimits();
          });
        });
      }
    } catch (e) {
      console.log('Could not set up g_form callback:', e);
    }
  };
  
  // Function to load authority limits
  c.loadAuthorityLimits = function() {
    console.log('Loading authority limits for job code:', c.jobCode);
    
    if (!c.jobCode) {
      c.authorityLimits = [];
      return;
    }
    
    c.loading = true;
    
    // Call server script to get authority limits
    c.server.get({
      action: 'getAuthorityLimits',
      job_code: c.jobCode,
      job_code_display: c.jobCodeDisplay
    }).then(function(response) {
      console.log('Server response:', response);
      c.authorityLimits = response.data.limits || [];
      if (response.data.jobCodeDisplay) {
        c.jobCodeDisplay = response.data.jobCodeDisplay;
      }
      c.loading = false;
    }).catch(function(error) {
      console.error('Error loading authority limits:', error);
      spUtil.addErrorMessage('Failed to load authority limits');
      c.authorityLimits = [];
      c.loading = false;
    });
  };
  
  // Initialize on load
  $timeout(function() {
    c.jobCode = c.getJobCodeValue();
    c.jobCodeDisplay = c.getJobCodeDisplayValue();
    console.log('Initial job code:', c.jobCode, 'Display:', c.jobCodeDisplay);
    
    if (c.jobCode) {
      c.loadAuthorityLimits();
    }
    
    // Set up monitoring for job code changes
    c.setupJobCodeMonitoring();
  }, 500);
};

<!-- SERVER SCRIPT -->
(function() {
  'use strict';

  if (input && input.action === 'getAuthorityLimits') {
    var jobCode = input.job_code;
    var limits = [];
    var jobCodeDisplayValue = '';
    
    if (jobCode) {
      // First, get the display value of the job code from the form
      // This is the actual job code value (like "JC001") not the sys_id
      var jobGr = new GlideRecord('x_banun_bunow_si_0_job_codes'); // Update this to your job codes table name
      if (jobGr.get(jobCode)) {
        jobCodeDisplayValue = jobGr.getDisplayValue();
      }
      
      // Query the authority limits table
      var gr = new GlideRecord('x_banun_bunow_si_0_authority_limits');
      gr.addQuery('job_code', jobCode);
      gr.addQuery('active', true);
      gr.query();
      
      while (gr.next()) {
        var limit = {
          // Credit limits
          overdraft_external_accounts: gr.getValue('overdraft_external_accounts'),
          overdraft_internal_accounts: gr.getValue('overdraft_internal_accounts'),
          unavailable_funds_external_accounts: gr.getValue('unavailable_funds_external_accounts'),
          unavailable_funds_internal_accounts: gr.getValue('unavailable_funds_internal_accounts'),
          
          // Non-credit limits
          disbursement_ach: gr.getValue('disbursement_ach'),
          disbursement_wire_transfer_external: gr.getValue('disbursement_wire_transfer_external'),
          disbursement_wire_transfer_internal: gr.getValue('disbursement_wire_transfer_internal'),
          disbursement_official_checks_external: gr.getValue('disbursement_official_checks_external'),
          disbursement_official_checks_internal: gr.getValue('disbursement_official_checks_internal'),
          check_cashing_on_us: gr.getValue('check_cashing_on_us'),
          check_cashing_not_on_us: gr.getValue('check_cashing_not_on_us'),
          remote_deposit: gr.getValue('remote_deposit'),
          treasury_solutions_company_wire_limits: gr.getValue('treasury_solutions_company_wire_limits'),
          fx_wire_limits: gr.getValue('fx_wire_limits')
        };
        
        limits.push(limit);
      }
    }
    
    data.limits = limits;
    data.jobCodeDisplay = jobCodeDisplayValue; // Send the display value to the client
  }
})();

(function runMailScript(current, template, email, email_action, event) {
    var parent, childRecord = null;
    var currentTableName = current.getTableName();

    // Determine context: approval notification or child state change
    if (currentTableName == 'sysapproval_approver') {
        // This is an approval/rejection email - current is sysapproval_approver
        var documentRecord = current.document_id.getRefRecord();
        
        // Validation check for document record
        if (!documentRecord || !documentRecord.isValidRecord()) {
            gs.error('Email Script Error: Unable to retrieve document record from sysapproval_approver');
            return;
        }
        
        var documentTableName = documentRecord.getTableName();
        if (documentTableName == 'x_banun_bunow_si_0_credit_authority_limits' ||
            documentTableName == 'x_banun_bunow_si_0_non_credit_authority_limits') {
            childRecord = documentRecord;
            parent = documentRecord.parent.getRefRecord();
        } else {
            parent = documentRecord;
        }
    } else if (currentTableName == 'x_banun_bunow_si_0_credit_authority_limits' || 
               currentTableName == 'x_banun_bunow_si_0_non_credit_authority_limits') {
        // This is a child state change notification - current is the child record
        childRecord = current;
        parent = childRecord.parent.getRefRecord();
    } else if (currentTableName == 'x_banun_bunow_si_0_signature_request') {
        // This is a parent table notification - current is the parent record
        parent = current;
    } else {
        gs.error('Email Script Error: Unexpected table context - ' + currentTableName);
        return;
    }

    // Validation check for parent
    if (!parent || !parent.isValidRecord()) {
        gs.error('Email Script Error: Unable to retrieve parent Signature Authority Request record');
        return;
    }

    // Only send email if parent state is "Closed Incomplete" (4)
    if (parent.state != 4) {
        return;
    }

    // Determine limit type if we have a child record
    var limitType = '';
    if (childRecord) {
        limitType = childRecord.getTableName() == 'x_banun_bunow_si_0_credit_authority_limits' ? 
                    'Credit Authority Limits' : 'Non-Credit Authority Limits';
    }

    var content = '';
    var instanceURL = gs.getProperty('glide.servlet.uri');
    var recordURL = instanceURL + 'x/banun/signature-authority-workspace/record/x_banun_bunow_si_0_signature_request/' + parent.sys_id;

    content += '<div style="font-family: Arial, sans-serif; color: #000000; max-width: 800px;">';

    // Rejection Details Section
    content += '<div style="background-color: #fff3cd; padding: 15px; margin: 20px 0; border-left: 4px solid #ffc107;">';
    content += '<h3 style="color: #856404; margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #ffc107;">Rejection Details</h3>';

    var hasRejections = false;

    // --- CHILD rejections (newest first) ---
    if (childRecord) {
        var childApprovalGr = new GlideRecord('sysapproval_approver');
        childApprovalGr.addQuery('sysapproval', childRecord.sys_id);
        childApprovalGr.addQuery('state', 'rejected');
        childApprovalGr.orderByDesc('sys_updated_on');
        childApprovalGr.query();

        if (childApprovalGr.hasNext()) {
            hasRejections = true;
            content += '<div style="margin-bottom: 20px;">';
            content += '<table style="width: 100%; border-collapse: collapse;">';

            // Reset query to iterate
            childApprovalGr = new GlideRecord('sysapproval_approver');
            childApprovalGr.addQuery('sysapproval', childRecord.sys_id);
            childApprovalGr.addQuery('state', 'rejected');
            childApprovalGr.orderByDesc('sys_updated_on');
            childApprovalGr.query();

            while (childApprovalGr.next()) {
                var rejector = childApprovalGr.approver.getDisplayValue();
                var rejectionDate = childApprovalGr.sys_updated_on.getDisplayValue();

                content += '<tr>';
                content += '<td style="padding: 12px; vertical-align: top; border-bottom: 1px solid #e0e0e0;">';
                content += '<div style="font-weight: bold; color: #000000; margin-bottom: 5px;">Rejected by: ' + rejector + '</div>';
                content += '<div style="color: #6c757d; font-size: 12px; margin-bottom: 8px;">' + rejectionDate + '</div>';

                // Latest journal comment for this approver record
                var journalGr = new GlideRecord('sys_journal_field');
                journalGr.addQuery('element_id', childApprovalGr.sys_id);
                journalGr.addQuery('element', 'comments');
                journalGr.orderByDesc('sys_created_on');
                journalGr.setLimit(1);
                journalGr.query();

                var comments = journalGr.next() ? (journalGr.getValue('value') || '') : '';

                if (comments.trim() !== '') {
                    content += '<div style="background-color: #ffffff; padding: 10px; border-radius: 4px; border: 1px solid #dee2e6;">';
                    content += '<div style="font-weight: bold; color: #495057; font-size: 12px; margin-bottom: 5px;">Comments:</div>';
                    content += '<div style="color: #000000; line-height: 1.5;">' + comments.replace(/\n/g, '<br/>') + '</div>';
                    content += '</div>';
                } else {
                    content += '<div style="color: #6c757d; font-style: italic;">No comments provided</div>';
                }

                content += '</td>';
                content += '</tr>';
            }

            content += '</table>';
            content += '</div>';
        }
    }

    // --- PARENT rejections (newest first) ---
    var parentApprovalGr = new GlideRecord('sysapproval_approver');
    parentApprovalGr.addQuery('sysapproval', parent.sys_id);
    parentApprovalGr.addQuery('state', 'rejected');
    parentApprovalGr.orderByDesc('sys_updated_on');
    parentApprovalGr.query();

    if (parentApprovalGr.hasNext()) {
        hasRejections = true;

        // Add separator if we showed child rejections
        if (childRecord) {
            var tempChildCheck = new GlideRecord('sysapproval_approver');
            tempChildCheck.addQuery('sysapproval', childRecord.sys_id);
            tempChildCheck.addQuery('state', 'rejected');
            tempChildCheck.query();
            if (tempChildCheck.hasNext()) {
                content += '<div style="border-top: 2px solid #ffc107; margin: 15px 0;"></div>';
            }
        }

        content += '<div style="margin-bottom: 20px;">';
        content += '<h4 style="color: #856404; margin: 0 0 10px 0; font-size: 14px;">Rejected at Parent Request Level:</h4>';
        content += '<table style="width: 100%; border-collapse: collapse;">';

        // Reset query to iterate
        parentApprovalGr = new GlideRecord('sysapproval_approver');
        parentApprovalGr.addQuery('sysapproval', parent.sys_id);
        parentApprovalGr.addQuery('state', 'rejected');
        parentApprovalGr.orderByDesc('sys_updated_on');
        parentApprovalGr.query();

        while (parentApprovalGr.next()) {
            var rejectorP = parentApprovalGr.approver.getDisplayValue();
            var rejectionDateP = parentApprovalGr.sys_updated_on.getDisplayValue();

            content += '<tr>';
            content += '<td style="padding: 12px; vertical-align: top; border-bottom: 1px solid #e0e0e0;">';
            content += '<div style="font-weight: bold; color: #000000; margin-bottom: 5px;">Rejected by: ' + rejectorP + '</div>';
            content += '<div style="color: #6c757d; font-size: 12px; margin-bottom: 8px;">' + rejectionDateP + '</div>';

            // Latest journal comment for this approver record
            var journalGrP = new GlideRecord('sys_journal_field');
            journalGrP.addQuery('element_id', parentApprovalGr.sys_id);
            journalGrP.addQuery('element', 'comments');
            journalGrP.orderByDesc('sys_created_on');
            journalGrP.setLimit(1);
            journalGrP.query();

            var commentsP = journalGrP.next() ? (journalGrP.getValue('value') || '') : '';

            if (commentsP.trim() !== '') {
                content += '<div style="background-color: #ffffff; padding: 10px; border-radius: 4px; border: 1px solid #dee2e6;">';
                content += '<div style="font-weight: bold; color: #495057; font-size: 12px; margin-bottom: 5px;">Comments:</div>';
                content += '<div style="color: #000000; line-height: 1.5;">' + commentsP.replace(/\n/g, '<br/>') + '</div>';
                content += '</div>';
            } else {
                content += '<div style="color: #6c757d; font-style: italic;">No comments provided</div>';
            }

            content += '</td>';
            content += '</tr>';
        }

        content += '</table>';
        content += '</div>';
    }

    // If no rejections found anywhere
    if (!hasRejections) {
        content += '<p style="color: #856404; font-style: italic;">No rejection details available. The request was closed incomplete without specific rejection comments.</p>';
    }

    content += '</div>';
    template.print(content);
})(current, template, email, email_action, event);
